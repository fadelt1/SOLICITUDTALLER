<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recepci√≥n de Taller</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .cardx{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f8fafc}
    .tile{transition:transform .15s ease, box-shadow .15s ease}
    .tile:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.08)}

    /* Overlays / Modales */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:flex-start;justify-content:center;overflow:auto}
    .overlay.show{display:flex}
    .os-box{background:#fff;border-radius:16px;margin:32px auto;max-width:920px;width:95%;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative;padding:24px}
    .close-x{position:absolute;right:16px;top:12px;border:none;background:transparent;font-size:26px;line-height:1;cursor:pointer}

    .submodal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:70;align-items:center;justify-content:center}
    .submodal.show{display:flex}
    .subcard{background:#fff;border-radius:12px;box-shadow:0 10px 35px rgba(0,0,0,.25);width:min(920px,95vw);max-height:80vh;overflow:auto;padding:16px}

    .btn-neutral{padding:.3rem .6rem;border-radius:.5rem;border:1px solid #cbd5e1;color:#334155;background:#fff;font-size:.85rem}
    .btn-neutral:hover{background:#f8fafc}
    .btn-primary{padding:.5rem 1rem;border-radius:.5rem;background:#059669;color:#fff}
    .btn-icon-danger{padding:.25rem .5rem;border-radius:.5rem;border:1px solid #fecaca;background:#fff;color:#b91c1c}
    .btn-icon-danger:hover{background:#fff1f2}

    /* Badges */
    .state-badge{display:inline-block;font-size:.75rem;padding:.2rem .5rem;border-radius:999px;border:1px solid}
    .state-on{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .state-off{background:#f8fafc;border-color:#e5e7eb;color:#475569}

    /* Timer visible */
    .time-badge{font-variant-numeric: tabular-nums;padding:.25rem .5rem;border-radius:.375rem;background:#f1f5f9;display:inline-block;min-width:80px;text-align:center;white-space:nowrap;font-size:.85rem}

    /* Radios bonitos */
    .radio-tile{display:flex;align-items:center;gap:.5rem;border:1px solid #e5e7eb;border-radius:.75rem;padding:.5rem .75rem;cursor:pointer}
    .radio-tile input{accent-color:#2563eb}

    /* PRIORIDAD */
    .prio{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid transparent}
    .prio-critico{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
    .prio-alto{background:#fef9c3;color:#a16207;border-color:#fde68a}
    .prio-bajo{background:#dcfce7;color:#166534;border-color:#bbf7d0}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- HEADER -->
  <header class="bg-[#0e2b47] text-white">
    <div class="max-w-[1200px] mx-auto px-4 py-3 flex items-center gap-3">
      <button class="w-9 h-9 grid place-content-center rounded-xl bg-white/10">‚ò∞</button>
      <h1 class="text-lg font-semibold">Solicitudes derivadas a Taller</h1>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        <span class="text-sm opacity-90">Hola, MIGUEL</span>
        <img src="https://randomuser.me/api/portraits/men/10.jpg" alt="avatar" class="w-9 h-9 rounded-full">
      </div>
    </div>
  </header>

  <!-- LISTA -->
  <main class="max-w-[1200px] mx-auto px-4 py-6">
    <section class="mb-3">
      <div class="flex items-center justify-between bg-[#0e2b47] text-white rounded-2xl px-4 py-3">
        <div class="flex items-center gap-2">
          <span>üßë‚Äçüîß</span>
          <span class="font-semibold tracking-wide">FORNECEDOR</span>
        </div>
        <div class="text-sm">TOTAL: <span id="total" class="font-bold">0</span></div>
      </div>
    </section>
    <section id="lista" class="space-y-4">
      <div class="text-center text-slate-500">Cargando‚Ä¶</div>
    </section>
  </main>

  <!-- ===================== MODAL OS ===================== -->
  <div id="osOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="os-box">
      <button id="osClose" class="close-x" title="Cerrar">√ó</button>

      <div class="flex items-start justify-between gap-3 mb-3">
        <div>
          <h2 id="titulo-os" class="text-xl font-bold">ORDEN DE SERVICIO</h2>
          <div class="text-sm text-slate-500">Resumen y acciones</div>
        </div>
        <div class="text-right">
          <div class="text-[11px] uppercase text-slate-500">Nro Solicitud</div>
          <div id="osNroSol" class="text-lg font-extrabold">‚Äî</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <section class="p-3 border rounded-lg bg-white">
          <h3 class="font-semibold text-slate-700 mb-2">Detalle de la solicitud</h3>
          <dl class="grid grid-cols-[120px_1fr] gap-y-2 text-sm">
            <dt class="font-semibold text-slate-500">Motivo</dt><dd id="motivoTxt">‚Äî</dd>
            <dt class="font-semibold text-slate-500">Lugar</dt><dd id="localTxt">‚Äî</dd>
            <dt class="font-semibold text-slate-500">Chofer</dt><dd id="osChofer">‚Äî</dd>
            <dt class="font-semibold text-slate-500">Ubicaci√≥n</dt><dd id="osUbicacion">‚Äî</dd>
            <dt class="font-semibold text-slate-500">Fecha/Hora</dt><dd id="osFechaHora">‚Äî</dd>
            <dt class="font-semibold text-slate-500">Comentario</dt><dd><div id="osComentario" class="whitespace-pre-wrap">‚Äî</div></dd>
            <dt class="font-semibold text-slate-500">Prioridad</dt><dd><span id="osPrioridad" class="prio">‚Äî</span></dd>
          </dl>
        </section>

        <section class="p-3 border rounded-lg bg-white">
          <h3 class="font-semibold text-slate-700 mb-2">Operaci√≥n</h3>
          <div class="mb-3">
            <label for="mecanicoSel" class="block text-sm font-semibold text-slate-500 mb-1">Mec√°nico <span class="text-rose-600">*</span></label>
            <select id="mecanicoSel" class="w-full rounded-lg border-slate-300">
              <option value="">Seleccione‚Ä¶</option>
              <option>ADILSON</option><option>MARCO</option><option>MARECOS</option><option>MARVIN</option>
            </select>
          </div>

          <div class="mb-3">
            <label id="lblConjunto" for="conjuntoSel" class="block text-sm font-semibold text-slate-500 mb-1">Conjunto *</label>
            <select id="conjuntoSel" class="w-full rounded-lg border-slate-300"></select>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
            <div class="p-2 bg-slate-50 rounded border">
              <div class="text-slate-500">Apertura</div>
              <div id="apertura" class="font-semibold">‚Äî</div>
            </div>
            <div class="p-2 bg-slate-50 rounded border">
              <div class="text-slate-500">Trabajo</div>
              <div id="workTimer" class="font-semibold">00:00:00</div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button class="btn-neutral" onclick="abrirModalServicios()">üõ† Servicios en la OS</button>
            <button class="btn-neutral" onclick="abrirModalInsumos()">üîß Insumos en la OS</button>
            <button class="btn-neutral" id="btnTransferirOs">üîÅ Transferir</button>
          </div>

          <!-- Servicio activo -->
          <div id="activeServiceBox" class="mt-3 hidden p-2 border rounded-lg bg-slate-50 text-sm">
            <div><span class="text-slate-500">En servicio:</span> <strong id="activeServiceName">‚Äî</strong></div>
            <div class="mt-1"><span class="text-slate-500">Tiempo:</span> <span id="activeServiceTime" class="font-semibold">00:00:00</span></div>
          </div>
        </section>
      </div>

      <section class="mt-4 p-3 bg-white rounded-lg border">
        <h3 class="font-semibold text-slate-700 mb-2">Resumen de la OS</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-2 rounded bg-slate-50 border"><div class="text-slate-500">Servicios agregados</div><div id="resumen-servicios" class="font-bold">0</div></div>
          <div class="p-2 rounded bg-slate-50 border"><div class="text-slate-500">Insumos agregados</div><div id="resumen-insumos" class="font-bold">0</div></div>
          <div class="p-2 rounded bg-slate-50 border"><div class="text-slate-500">Tiempo total de la OS</div><div id="tiempo-os" class="font-bold">00:00:00</div></div>
          <div class="p-2 rounded bg-slate-50 border"><div class="text-slate-500">Tiempo total (servicios)</div><div id="tiempo-total" class="font-bold">00:00:00</div></div>
        </div>
      </section>

      <div class="flex items-center justify-between mt-4">
        <button id="btnCerrar" class="px-4 py-2 rounded-lg border border-red-300 text-red-700 hover:bg-red-50">Cerrar OS</button>
        <button id="btnIniciar" class="btn-primary">Iniciar OS</button>
      </div>

      <!-- ===== Sub-modal: Servicios ===== -->
      <div id="modal-servicios" class="submodal" role="dialog" aria-modal="true">
        <div class="subcard">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h5 class="m-0 text-lg font-semibold">Servicios en la OS</h5>
              <p class="text-slate-500 text-sm mt-0.5">Administr√° los servicios, tiempos y t√©cnico.</p>
            </div>
            <div class="flex gap-2">
              <button class="btn-neutral" onclick="agregarServicio()">‚ûï Agregar servicio</button>
              <button class="btn-neutral" onclick="cerrarModalServicios()">‚úï Cerrar</button>
            </div>
          </div>

          <div class="hidden md:grid grid-cols-[1fr_140px_120px_160px_120px] gap-2 px-2 py-2 text-xs font-semibold text-slate-500">
            <div>Servicio</div><div>Estado</div><div>Aplica a</div><div>Tiempo</div><div class="text-right">Acciones</div>
          </div>

          <div id="servicios-container" class="mt-2"></div>
          <div id="svc-empty" class="text-center text-slate-500 py-8 hidden">No hay servicios todav√≠a. Us√° <span class="font-semibold">‚ÄúAgregar servicio‚Äù</span>.</div>

          <div class="flex items-center justify-between mt-3">
            <div class="text-sm text-slate-600">Tiempo total: <strong id="svc-total">00:00:00</strong></div>
          </div>
        </div>
      </div>

      <!-- ===== Sub-modal: Insumos ===== -->
      <div id="modal-insumos" class="submodal" role="dialog" aria-modal="true">
        <div class="subcard">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h5 class="m-0 text-lg font-semibold">Insumos en la OS</h5>
              <p class="text-slate-500 text-sm mt-0.5">Agreg√° y gestion√° cantidades.</p>
            </div>
            <div class="flex gap-2">
              <button class="btn-neutral" onclick="agregarInsumo()">‚ûï Agregar insumo</button>
              <button class="btn-neutral" onclick="cerrarModalInsumos()">‚úï Cerrar</button>
            </div>
          </div>

          <div class="hidden md:grid grid-cols-[1fr_120px_140px_120px] gap-2 px-2 py-2 text-xs font-semibold text-slate-500">
            <div>Insumo</div><div>Aplica a</div><div>Cantidad</div><div class="text-right">Acciones</div>
          </div>

          <div id="insumos-container" class="mt-2"></div>
          <div id="ins-empty" class="text-center text-slate-500 py-8 hidden">Todav√≠a no agregaste insumos.</div>
        </div>
      </div>
    </div>
  </div>
  <!-- ===================== FIN MODAL OS ===================== -->

  <!-- ===== Modal TRANSFERIR ===== -->
  <div id="transferOverlay" class="submodal" role="dialog" aria-modal="true">
    <div class="subcard">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h5 class="m-0 text-lg font-semibold">Transferir solicitud</h5>
          <p class="text-slate-500 text-sm mt-0.5">Eleg√≠ a d√≥nde transferir esta solicitud.</p>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-2">
        <label class="radio-tile">
          <input type="radio" name="destTransfer" value="PROVEEDOR" checked>
          <span>Proveedor (Terceros)</span>
        </label>
        <label class="radio-tile">
          <input type="radio" name="destTransfer" value="COMPRAS">
          <span>Derivado Compras</span>
        </label>
      </div>

      <div class="flex items-center justify-end gap-2 mt-4">
        <button class="btn-neutral" id="transferCancel">Cancelar</button>
        <button class="btn-primary" id="transferConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, push, set, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    /* ========== Firebase ========== */
    const SOLICITUDES_CONFIG = {
      apiKey: "AIzaSyCHPVzlKuwPsM9JDrEQYwX2GumvunM7bso",
      authDomain: "solicitudes-b1d93.firebaseapp.com",
      databaseURL: "https://solicitudes-b1d93-default-rtdb.firebaseio.com",
      projectId: "solicitudes-b1d93",
      storageBucket: "solicitudes-b1d93.firebasestorage.app",
      messagingSenderId: "588418332403",
      appId: "1:588418332403:web:1523983421aa238562a986",
      measurementId: "G-819DG1W1MQ"
    };
    const appSolicitudes = initializeApp(SOLICITUDES_CONFIG, 'solicitudes');
    const dbSolicitudes  = getDatabase(appSolicitudes);

    const SERVICIOS_CONFIG = {
      apiKey: "AIzaSyCwVgL-mhxqeGfsO-OosTwQDCM_Ue_Ye2g",
      authDomain: "serviciosos-8754c.firebaseapp.com",
      projectId: "serviciosos-8754c",
      storageBucket: "serviciosos-8754c.firebasestorage.app",
      messagingSenderId: "694094369320",
      appId: "1:694094369320:web:1a9a223ddafb0e860fdb1d",
      measurementId: "G-E648183BF8"
    };
    const SERVICIOS_DB_URL = 'https://serviciosos-8754c-default-rtdb.firebaseio.com';
    const appServicios = initializeApp(SERVICIOS_CONFIG, 'servicios');
    const dbServicios  = getDatabase(appServicios, SERVICIOS_DB_URL);

    const R_OS  = '/os';

    /* ========== Helpers ========== */
    const $id = (id)=> document.getElementById(id);
    const setText = (id, v)=>{ const el=$id(id); if(el) el.textContent=v; };
    const pad2 = (n)=> String(n).padStart(2,'0');
    const fmtDDMMYYYY_HHMM = (dLike)=>{
      const d=(dLike instanceof Date)?dLike:new Date(dLike||Date.now());
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };
    const parseAnyTs = (v)=>{
      if(v==null) return 0; if(typeof v==='number') return v;
      const m=(typeof v==='string')?v.match(/^(\d{2})\/(\d{2})\/(\d{4})\s(\d{2}):(\d{2})(?::(\d{2}))?$/):null;
      if(m){ return new Date(+m[3],+m[2]-1,+m[1],+m[4],+m[5],+(m[6]||0)).getTime(); }
      const p=Date.parse(v); return isNaN(p)?0:p;
    };
    const fmt=(secs)=>{ const s=Math.max(0,Math.floor(secs||0)); const h=pad2(Math.floor(s/3600)), m=pad2(Math.floor((s%3600)/60)), ss=pad2(s%60); return `${h}:${m}:${ss}`; };

    const lista = document.querySelector('#lista');
    const totalEl = document.querySelector('#total');

    let currentSolId=null, currentNroOS=null, workInt=null, currentStartWorkMS=0, currentTipo=null;
    let activeSvcKey=null, activeSvcInt=null;

    // NUEVO: recordar n√∫meros de unidades
    let cavaloNum=null;   // MOVIL de la solicitud
    let carretaNum=null;  // seleccionado en "Conjunto"

    const timersByKey = {};
    const LISTA_SERVICIOS=['CAMBIO DE ACEITE','AJUSTE DE FRENOS','REVISI√ìN DE LUCES','CAMBIO DE FILTROS','ALINEACI√ìN','BALANCEO'];
    const LISTA_INSUMOS=['FOCO 24V 21W','FOCO 24V 5W','FILTRO MANN C27830 MFAR CUMMINS'];
    const LISTA_CONJUNTO = Array.from({length:30},(_,i)=> 730 + i); // 730..759

    /* PRIORIDAD helpers */
    const prioKey = (v)=> (String(v||'').trim().toLowerCase());
    const prioClass = (v)=>{
      const k=prioKey(v);
      if(k==='critico' || k==='cr√≠tico') return 'prio prio-critico';
      if(k==='alto') return 'prio prio-alto';
      if(k==='bajo') return 'prio prio-bajo';
      return 'prio';
    };
    const paintPrioEl = (el, v)=>{
      if(!el) return; el.className = prioClass(v); el.textContent = (v||'‚Äî').toString().toUpperCase();
    };

    /* ========== Listado principal ========== */
    function cardHTML(item){
      const id=item.id, mov=item.MOVIL||'‚Äî', chofer=item.CHOFER||'', ubic=item['UBICACI√ìN']||'', motivo=item.MOTIVO||'', tipo=item.TIPO||'', nro=item.NRO_SOLICITUD||'‚Äî';
      const prio=item.PRIORIDAD||''; const mecanico=item.MECANICO||'';
      const started=!!(item.OS_INICIADA && item.OS_START_TS);
      const startWait=item._ts?+item._ts:parseAnyTs(item['FECHA Y HORA']);
      const startBase= started? parseAnyTs(item.OS_START_TS) : startWait;
      const fh=item['FECHA Y HORA']||'‚Äî';
      const label= started? 'Tiempo total' : 'Espera';
      return `<button class="w-full text-left cardx p-4 tile" data-id="${id}">
        <div class="flex items-start gap-3">
          <div class="text-2xl">üöö</div>
          <div class="flex-1">
            <div class="flex items-baseline justify-between gap-2">
              <div class="flex items-baseline gap-3">
                <div class="text-lg font-extrabold">${mov}</div>
                ${chofer?`<div class="text-slate-500 text-sm">${chofer}</div>`:''}
              </div>
              <div class="text-right">
                <div class="text-slate-500 text-[11px] uppercase">Nro Solicitud</div>
                <div class="font-bold">${nro}</div>
              </div>
            </div>
            <div class="mt-2 grid grid-cols-[18px_1fr] gap-x-2 text-[13px] text-slate-600">
              <div>üìç</div><div>${ubic}</div>
              <div>üïí</div><div>${fh}</div>
              <div>‚è±Ô∏è</div><div class="font-semibold ${started?'text-slate-700':'text-rose-600'}">${label}: <span class="cron" data-start="${startBase}"></span></div>
              ${mecanico?`<div>üßë‚Äçüîß</div><div><span class="text-slate-700 font-medium">Mec√°nico:</span> ${mecanico}</div>`:''}
            </div>
            <div class="mt-2 flex items-center gap-2 flex-wrap">
              ${motivo?`<span class="chip">${motivo}</span>`:''}
              ${tipo?`<span class="chip">${tipo}</span>`:''}
              ${prio?`<span class="${prioClass(prio)}">${String(prio).toUpperCase()}</span>`:''}
            </div>
            <!-- Servicio activo en la tarjeta -->
            <div class="svc-active hidden mt-2 text-[13px] text-slate-700">üõ† <span class="svc-name">‚Äî</span> ‚Äî <span class="svc-cron" data-start="0" data-base="0">00:00:00</span></div>
          </div>
        </div>
      </button>`;
    }
    function render(arr){
      totalEl.textContent = String(arr.length);
      if(!arr.length){ lista.innerHTML='<div class="text-center text-slate-500">No hay solicitudes derivadas a Taller.</div>'; return; }
      arr.sort((a,b)=>{const ta=a._ts?+a._ts:parseAnyTs(a['FECHA Y HORA']); const tb=b._ts?+b._ts:parseAnyTs(b['FECHA Y HORA']); return ta-tb;});
      lista.innerHTML = arr.map(cardHTML).join('');
      if(!lista._bound){
        lista.addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-id]'); if(btn) openOSModal(btn.dataset.id); });
        lista._bound=true;
      }
      // Completar datos de servicio activo por tarjeta
      arr.forEach(async (it)=>{
        const btn = lista.querySelector(`button[data-id="${it.id}"]`); if(!btn) return;
        const svcBox = btn.querySelector('.svc-active'); const nm=btn.querySelector('.svc-name'); const tm=btn.querySelector('.svc-cron');
        try{
          const svSnap = await get(ref(dbServicios, `${R_OS}/${it.id}/servicios`));
          if(svSnap.exists()){
            let found=null; svSnap.forEach(s=>{ const v=s.val()||{}; if(v.start_ts && !v.end_ts && !found){ found={start:v.start_ts, base: Number(v.duration_sec||0), name: v.nombre||'SERVICIO'}; } });
            if(found){ if(nm) nm.textContent=found.name; if(tm){ tm.dataset.start=String(parseAnyTs(found.start)); tm.dataset.base=String(found.base||0); tm.textContent='00:00:00'; } if(svcBox) svcBox.classList.remove('hidden'); }
          }
        }catch(e){ console.error('svc fetch', e); }
      });
    }
    onValue(ref(dbSolicitudes,'/'),(snap)=>{
      const arr=[]; snap.forEach(ch=>{const v=ch.val()||{}; if((v.STATUS_DE_SOLICITUD||'')==='TALLER') arr.push({id:ch.key, ...v});});
      render(arr);
    });
    setInterval(()=>{
      document.querySelectorAll('.cron').forEach(el=>{ const st=Number(el.dataset.start)||Date.now(); const diff=Math.floor((Date.now()-st)/1000); el.textContent=fmt(diff); });
      document.querySelectorAll('.svc-cron').forEach(el=>{ const st=Number(el.dataset.start)||0; const base=Number(el.dataset.base)||0; if(st>0){ const diff=base + Math.floor((Date.now()-st)/1000); el.textContent=fmt(diff);} });
    },1000);

    /* ========== Modal OS ========== */
    const overlay=$id('osOverlay'); const btnIniciar=$id('btnIniciar'); const btnCerrar=$id('btnCerrar');
    $id('osClose').addEventListener('click',()=>overlay.classList.remove('show'));
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) overlay.classList.remove('show'); });

    function buildConjuntoOptions(selected){
      const sel=$id('conjuntoSel'); if(!sel) return;
      sel.innerHTML = '<option value="">Seleccione‚Ä¶</option>' + LISTA_CONJUNTO.map(n=>`<option value="${n}" ${String(selected)==String(n)?'selected':''}>${n}</option>`).join('');
      sel.onchange = ()=> { carretaNum = Number(sel.value||0)||null; };
    }

    async function openOSModal(solId){
      if(workInt){ clearInterval(workInt); workInt=null; }
      if(activeSvcInt){ clearInterval(activeSvcInt); activeSvcInt=null; } activeSvcKey=null;
      currentSolId=solId;
      const snap=await get(ref(dbSolicitudes,'/'+solId)); if(!snap.exists()){ alert('No se encontr√≥ la solicitud.'); return; }
      const s=snap.val()||{}; currentNroOS=s.NRO_SOLICITUD||null; currentTipo=(s.TIPO||'').toUpperCase();

      // N√∫meros de unidades
      cavaloNum  = Number(s.MOVIL || 0) || null;       // cavalo = movil
      carretaNum = Number(s.CONJUNTO || 0) || null;    // si ya estaba guardado

      setText('titulo-os', `ORDEN DE SERVICIO ‚Äì Solicitud ${s.NRO_SOLICITUD||'‚Äî'}`);
      setText('osChofer', s.CHOFER||'‚Äî'); setText('osUbicacion', s['UBICACI√ìN']||'‚Äî');
      setText('osFechaHora', s['FECHA Y HORA']||'‚Äî'); setText('osNroSol', s.NRO_SOLICITUD||'‚Äî');
      setText('motivoTxt', s.MOTIVO||'‚Äî'); setText('localTxt', s.DESTINO||'‚Äî');
      setText('osComentario', s.COMENTARIO||s.Comentario||'‚Äî');
      paintPrioEl($id('osPrioridad'), s.PRIORIDAD||'‚Äî');
      setText('apertura', s.OS_START_TS||'‚Äî');
      const sel=$id('mecanicoSel'); if(sel) sel.value=s.MECANICO||'';

      const lbl=$id('lblConjunto');
      if(lbl){
        if(currentTipo==='CAVALO') lbl.textContent='Carreta del conjunto *';
        else if(currentTipo==='CARRETA') lbl.textContent='Cavalo del conjunto *';
        else lbl.textContent='Conjunto *';
      }
      buildConjuntoOptions(s.CONJUNTO||'');

      const started=!!s.OS_INICIADA && !!s.OS_START_TS;
      if(btnIniciar){ btnIniciar.disabled=started; btnIniciar.textContent=started?'OS INICIADA':'INICIAR OS'; }
      currentStartWorkMS=started?parseAnyTs(s.OS_START_TS):0;

      const workTimerEl=$id('workTimer');
      if(workTimerEl) workTimerEl.textContent=started?fmt(Math.floor((Date.now()-currentStartWorkMS)/1000)):'00:00:00';
      setText('tiempo-os', started ? fmt(Math.floor((Date.now()-currentStartWorkMS)/1000)) : '00:00:00');

      if(started && workTimerEl){
        workInt=setInterval(()=>{
          const sec = Math.floor((Date.now()-currentStartWorkMS)/1000);
          workTimerEl.textContent = fmt(sec);
          setText('tiempo-os', fmt(sec));
        },1000);
      }

      $id('servicios-container').innerHTML=''; $id('insumos-container').innerHTML='';
      setText('resumen-servicios','0'); setText('resumen-insumos','0');
      setText('tiempo-total','00:00:00'); setText('svc-total','00:00:00'); setText('tiempo-os','00:00:00');
      for(const k in timersByKey){ if(timersByKey[k].h) clearInterval(timersByKey[k].h); delete timersByKey[k]; }

      await rebuildServiciosInsumos(solId);

      // Detectar servicio activo al abrir
      const svSnap=await get(ref(dbServicios, `${R_OS}/${solId}/servicios`));
      if(svSnap.exists()){
        svSnap.forEach(sv=>{ const v=sv.val()||{}; if(v.start_ts && !v.end_ts && !activeSvcKey){ activeSvcKey=sv.key; showActiveService(v.nombre||'SERVICIO'); } });
      }

      overlay.classList.add('show');
    }

    if(btnIniciar) btnIniciar.addEventListener('click', async ()=>{
      if(!currentSolId) return;
      const mecanico=$id('mecanicoSel')?.value?.trim()||'';
      if(!mecanico){ alert('Seleccione el mec√°nico.'); return; }
      const conjuntoSel=$id('conjuntoSel')?.value?.trim()||'';
      if(!conjuntoSel){ alert('Seleccione el conjunto.'); return; }

      // fijar n√∫meros
      carretaNum = Number(conjuntoSel);
      cavaloNum  = Number(cavaloNum||0) || null;

      const now=Date.now();
      await update(ref(dbSolicitudes,'/'+currentSolId), {
        OS_INICIADA:true,
        OS_START_TS: fmtDDMMYYYY_HHMM(now),
        MECANICO: mecanico,
        CONJUNTO: String(carretaNum),
        CAVALO_NUM: cavaloNum,
        CARRETA_NUM: carretaNum
      });
      btnIniciar.disabled=true; btnIniciar.textContent='OS INICIADA';
      currentStartWorkMS=now;
      const workTimerEl=$id('workTimer');
      if(workInt) clearInterval(workInt);
      if(workTimerEl) workInt=setInterval(()=>{
        const sec = Math.floor((Date.now()-currentStartWorkMS)/1000);
        workTimerEl.textContent = fmt(sec);
        setText('tiempo-os', fmt(sec));
      },1000);
    });

    /* Sub-modales open/close */
    window.abrirModalServicios = ()=> $id('modal-servicios').classList.add('show');
    window.cerrarModalServicios = ()=> $id('modal-servicios').classList.remove('show');
    window.abrirModalInsumos   = ()=> $id('modal-insumos').classList.add('show');
    window.cerrarModalInsumos  = ()=> $id('modal-insumos').classList.remove('show');

    /* Recaps y tiempos */
    function recap(){
      setText('resumen-servicios', String(document.querySelectorAll('#servicios-container .svc-row').length));
      setText('resumen-insumos', String(document.querySelectorAll('#insumos-container .ins-row').length));
    }
    function totalTime(){
      const totalSec = Object.keys(timersByKey).reduce((a,k)=> a + (timersByKey[k].seg||0), 0);
      setText('tiempo-total', fmt(totalSec));
      setText('svc-total', fmt(totalSec));
      recap();
    }

    function showActiveService(name){
      const box=$id('activeServiceBox'); const nm=$id('activeServiceName'); const tm=$id('activeServiceTime');
      if(!box||!nm||!tm) return;
      nm.textContent=name||'‚Äî';
      box.classList.remove('hidden');
      if(activeSvcInt) clearInterval(activeSvcInt);
      activeSvcInt=setInterval(()=>{
        const t= timersByKey[activeSvcKey];
        tm.textContent = fmt(t?.seg||0);
      },1000);
    }
    function hideActiveService(){
      const box=$id('activeServiceBox'); if(box) box.classList.add('hidden');
      if(activeSvcInt){ clearInterval(activeSvcInt); activeSvcInt=null; }
      activeSvcKey=null;
    }

    /* ===== Servicios ===== */
    function crearFilaServicio(key, data){
      const nombre = data?.nombre || 'SERVICIO';
      const serviceNumber = data?.service_number || 0;
      const aplica = (data?.aplica||'').toUpperCase();

      const row = document.createElement('div');
      row.dataset.key = key;
      row.className = "svc-row grid grid-cols-[1fr_140px_120px_160px_120px] gap-2 items-center rounded-lg border px-3 py-2 bg-white";

      const setS = new Set(LISTA_SERVICIOS); if(!setS.has(nombre)) setS.add(nombre);
      const opts = [...setS].map(s => `<option${s===nombre?' selected':''}>${s}</option>`).join('');

      const base = Number(data?.duration_sec || 0);
      const running = !!(data?.start_ts && !data?.end_ts);
      timersByKey[key] = { seg: base, h: null };

      row.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="hidden md:inline text-slate-400 text-xs">#${serviceNumber}</span>
          <select class="flex-1 rounded-md border-slate-300" onchange="updateServiceName(this, '${key}')">
            ${opts}
          </select>
        </div>
        <div class="md:text-center">
          <span id="state-${key}" class="state-badge ${running?'state-on':'state-off'}">${running ? 'En curso' : 'Detenido'}</span>
        </div>
        <div class="flex items-center justify-start md:justify-center">
          <select id="aplica-${key}" class="rounded-md border-slate-300 text-sm">
            <option value="">‚Äî</option>
            <option value="CAVALO" ${aplica==='CAVALO'?'selected':''}>Cavalo</option>
            <option value="CARRETA" ${aplica==='CARRETA'?'selected':''}>Carreta</option>
          </select>
        </div>
        <div class="flex items-center justify-start md:justify-center">
          <span id="tm-${key}" class="time-badge">00:00:00</span>
        </div>
        <div class="flex md:justify-end gap-2">
          <button id="start-${key}" class="btn-neutral" onclick="startTimer('${key}', this)">Iniciar</button>
          <button id="stop-${key}"  class="btn-neutral" onclick="stopTimer('${key}', this)" disabled>Detener</button>
          <button class="btn-icon-danger" title="Eliminar" onclick="deleteServiceRow(this, '${key}')">√ó</button>
        </div>
      `;

      $id('servicios-container').appendChild(row);
      $id('svc-empty')?.classList.add('hidden');

      const sp    = $id(`tm-${key}`);
      const stBtn = $id(`start-${key}`);
      const enBtn = $id(`stop-${key}`);
      const badge = $id(`state-${key}`);
      const paint = ()=>{ if (sp) sp.textContent = fmt(timersByKey[key].seg); };

      if (running){
        timersByKey[key].seg = base + Math.max(0, Math.floor((Date.now()-parseAnyTs(data.start_ts))/1000));
        paint();
        if (stBtn) stBtn.disabled = true;
        if (enBtn) enBtn.disabled = false;
        if (badge){ badge.textContent='En curso'; badge.classList.remove('state-off'); badge.classList.add('state-on'); }
        timersByKey[key].h = setInterval(()=>{ timersByKey[key].seg++; paint(); totalTime(); },1000);
      } else { paint(); }

      totalTime(); recap();
    }

    window.agregarServicio = async function(nombre, seg){
      nombre = nombre || ''; seg = seg || 0; if(!currentSolId){ alert('Abr√≠ una solicitud'); return; }
      const svSnap = await get(ref(dbServicios, `${R_OS}/${currentSolId}/servicios`));
      const serviceNumber = svSnap.exists()? (Object.keys(svSnap.val()||{}).length+1) : 1;
      const mecanico=$id('mecanicoSel')?.value || null;

      const newRef=push(ref(dbServicios, `${R_OS}/${currentSolId}/servicios`)); const key=newRef.key;
      await set(newRef,{
        solicitud_id: currentSolId,
        nro_os: currentNroOS||null,
        service_number: serviceNumber,
        nombre: nombre||'SERVICIO',
        tecnico: mecanico,
        aplica: '',
        conjunto: String(carretaNum||''),
        cavalo_num: cavaloNum,     // referencia
        carreta_num: carretaNum,   // referencia
        unit_number: null,         // se fija al iniciar seg√∫n aplica
        created_ts: fmtDDMMYYYY_HHMM(Date.now()),
        start_ts: null, end_ts: null, duration_sec: 0
      });
      crearFilaServicio(key, {nombre, service_number: serviceNumber, duration_sec: seg, aplica: '', conjunto:String(carretaNum||'')});
    };
    window.updateServiceName = async function(sel,key){ if(!key) return; await update(ref(dbServicios, `${R_OS}/${currentSolId}/servicios/${key}`), { nombre: sel.value||'SERVICIO' }); };

    // Iniciar servicio
    window.startTimer = async function(key,btn){
      const t=timersByKey[key]; if(!t) return;
      const aplicaSel=$id(`aplica-${key}`); 
      const aplica=(aplicaSel?.value||'').toUpperCase().trim();
      if(!aplica){ alert('Seleccion√° si el servicio aplica a Cavalo o Carreta.'); return; }

      const unit_number = (aplica==='CAVALO') ? (cavaloNum||null) : (carretaNum||null);
      if(!unit_number){ alert('No se pudo determinar el n√∫mero de unidad. Verific√° conjunto/cavalo.'); return; }

      btn.disabled=true; btn.nextElementSibling.disabled=false;
      await update(ref(dbServicios, `${R_OS}/${currentSolId}/servicios/${key}`), { 
        aplica, 
        conjunto: String(carretaNum||''), 
        unit_number, 
        start_ts: fmtDDMMYYYY_HHMM(Date.now()), 
        end_ts: null 
      });

      // UI modal
      const sp=$id(`tm-${key}`), badge=$id(`state-${key}`);
      if(t.h) clearInterval(t.h);
      if(badge){ badge.textContent='En curso'; badge.classList.remove('state-off'); badge.classList.add('state-on'); }
      t.h=setInterval(()=>{ t.seg=(t.seg||0)+1; if(sp) sp.textContent=fmt(t.seg); totalTime(); },1000);

      // Mostrar servicio activo en Operaci√≥n
      activeSvcKey=key;
      const nameSel = btn.closest('.svc-row').querySelector('select');
      showActiveService(nameSel?.value||'SERVICIO');

      // Actualizar tarjeta inmediatamente
      const card=document.querySelector(`button[data-id="${currentSolId}"]`);
      if(card){
        const box=card.querySelector('.svc-active');
        const nm=card.querySelector('.svc-active .svc-name');
        const tm=card.querySelector('.svc-active .svc-cron');
        if(box) box.classList.remove('hidden');
        if(nm) nm.textContent = (nameSel?.value||'SERVICIO');
        if(tm){
          tm.dataset.start = String(Date.now());
          tm.dataset.base  = String(t.seg||0);
          tm.textContent   = '00:00:00';
        }
      }
    };

    // Detener servicio
    window.stopTimer = async function(key,btn){
      const t=timersByKey[key]; if(!t) return;

      if(t.h){ clearInterval(t.h); t.h=null; }
      btn.disabled=true;
      const startBtn=$id(`start-${key}`); if(startBtn) startBtn.disabled=false;
      await update(ref(dbServicios, `${R_OS}/${currentSolId}/servicios/${key}`), { 
        end_ts: fmtDDMMYYYY_HHMM(Date.now()), 
        duration_sec: t.seg||0 
      });
      const badge=$id(`state-${key}`); 
      if(badge){ badge.textContent='Detenido'; badge.classList.remove('state-on'); badge.classList.add('state-off'); }

      if(activeSvcKey===key){ hideActiveService(); }
      totalTime();

      // Reset en tarjeta
      const card=document.querySelector(`button[data-id="${currentSolId}"]`);
      if(card){
        const box=card.querySelector('.svc-active');
        const tm=card.querySelector('.svc-active .svc-cron');
        if(box) box.classList.add('hidden');
        if(tm){
          tm.dataset.start = "0";
          tm.dataset.base  = "0";
          tm.textContent   = "00:00:00";
        }
      }
    };
    window.deleteServiceRow = async function(el,key){
      const row=el.closest('.grid');
      if(key){ await remove(ref(dbServicios, `${R_OS}/${currentSolId}/servicios/${key}`)); }
      const t=timersByKey[key]; if(t&&t.h) clearInterval(t.h);
      if(activeSvcKey===key){ hideActiveService(); }
      delete timersByKey[key];
      if(row) row.remove();
      if(!document.querySelector('#servicios-container .grid')) $id('svc-empty')?.classList.remove('hidden');
      totalTime(); recap();
    };

    /* ===== Insumos ===== */
    function crearFilaInsumo(key, data){
      const nombre = data?.nombre || 'INSUMO';
      const cantidad = Number(data?.cantidad||1);
      const aplica = (data?.aplica||'').toUpperCase();

      const row=document.createElement('div');
      row.dataset.key=key;
      row.className="ins-row grid grid-cols-[1fr_120px_140px_120px] gap-2 items-center rounded-lg border px-3 py-2 bg-white";

      const setI=new Set(LISTA_INSUMOS); if(!setI.has(nombre)) setI.add(nombre);
      const opts=[...setI].map(s=>`<option${s===nombre?' selected':''}>${s}</option>`).join('');

      row.innerHTML = `
        <div class="flex items-center gap-2">
          <select class="flex-1 rounded-md border-slate-300" onchange="updateInsumoNombre(this)">${opts}</select>
        </div>
        <div>
          <select class="rounded-md border-slate-300 text-sm" onchange="updateInsumoAplica(this)">
            <option value="" ${aplica===''?'selected':''}>‚Äî</option>
            <option value="CAVALO" ${aplica==='CAVALO'?'selected':''}>Cavalo</option>
            <option value="CARRETA" ${aplica==='CARRETA'?'selected':''}>Carreta</option>
          </select>
        </div>
        <div>
          <input type="number" min="1" class="w-full rounded-md border-slate-300 px-2 py-1" value="${cantidad}" onchange="updateInsumoCantidad(this)">
        </div>
        <div class="flex justify-end gap-2">
          <button class="btn-icon-danger" title="Eliminar" onclick="deleteInsumoRow(this)">√ó</button>
        </div>
      `;
      $id('insumos-container').appendChild(row);
      $id('ins-empty')?.classList.add('hidden');
      recap();
    }

    async function rebuildServiciosInsumos(solId){
      const svcsSnap = await get(ref(dbServicios, `${R_OS}/${solId}/servicios`));
      if(svcsSnap.exists()){ svcsSnap.forEach(ch=> crearFilaServicio(ch.key, ch.val()||{}) ); }
      const insSnap  = await get(ref(dbServicios, `${R_OS}/${solId}/insumos`));
      if(insSnap.exists()) { insSnap.forEach(ch=> crearFilaInsumo(ch.key, ch.val()||{}) ); }
      totalTime(); recap();
    }

    // CRUD Insumos
    window.agregarInsumo = async function(nombre, cantidad){
      nombre=nombre||''; cantidad=Number(cantidad||1);
      if(!currentSolId){ alert('Abr√≠ una solicitud'); return; }
      const newRef=push(ref(dbServicios, `${R_OS}/${currentSolId}/insumos`)); const key=newRef.key;
      await set(newRef,{ 
        solicitud_id: currentSolId, nro_os: currentNroOS||null, 
        nombre: nombre||'INSUMO', aplica:'', cantidad,
        conjunto: String(carretaNum||''),
        cavalo_num: cavaloNum, carreta_num: carretaNum,
        unit_number: null,
        created_ts: fmtDDMMYYYY_HHMM(Date.now()) 
      });
      crearFilaInsumo(key, {nombre, cantidad, aplica:''});
    };
    window.updateInsumoNombre = async function(sel){
      const key=sel.closest('.ins-row').dataset.key;
      await update(ref(dbServicios, `${R_OS}/${currentSolId}/insumos/${key}`), { nombre: sel.value||'INSUMO' });
    };
    window.updateInsumoAplica = async function(sel){
      const key=sel.closest('.ins-row').dataset.key;
      const val=(sel.value||'').toUpperCase().trim();
      const unit_number = (val==='CAVALO') ? (cavaloNum||null) : (carretaNum||null);
      await update(ref(dbServicios, `${R_OS}/${currentSolId}/insumos/${key}`), { aplica: val, unit_number, conjunto: String(carretaNum||'') });
    };
    window.updateInsumoCantidad = async function(inp){
      const key=inp.closest('.ins-row').dataset.key;
      const val=Number(inp.value)||1;
      await update(ref(dbServicios, `${R_OS}/${currentSolId}/insumos/${key}`), { cantidad: val });
      recap();
    };
    window.deleteInsumoRow = async function(btn){
      const row=btn.closest('.ins-row');
      const key=row.dataset.key;
      await remove(ref(dbServicios, `${R_OS}/${currentSolId}/insumos/${key}`));
      row.remove();
      if(!document.querySelector('#insumos-container .ins-row')) $id('ins-empty')?.classList.remove('hidden');
      recap();
    };

    /* Cerrar OS */
    if(btnCerrar) btnCerrar.addEventListener('click', async ()=>{
      if(!currentSolId) return;
      // Valida insumos
      const insSnap = await get(ref(dbServicios, `${R_OS}/${currentSolId}/insumos`));
      if(insSnap.exists()){
        let falta=false; insSnap.forEach(s=>{ const v=s.val()||{}; const a=(v.aplica||'').trim(); if(a==='') falta=true; });
        if(falta){ alert('Hay insumos sin ‚ÄúAplica a‚Äù (Cavalo/Carreta). Complet√° antes de cerrar.'); return; }
      }
      // Valida servicios
      const svcsSnap=await get(ref(dbServicios, `${R_OS}/${currentSolId}/servicios`));
      if(svcsSnap.exists()){
        let falta=false; svcsSnap.forEach(s=>{ const v=s.val()||{}; const a=(v.aplica||'').trim(); if(a==='') falta=true; });
        if(falta){ alert('Hay servicios sin ‚ÄúAplica a‚Äù (Cavalo/Carreta). Complet√° antes de cerrar.'); return; }
        const updates={}; svcsSnap.forEach(s=>{ const v=s.val()||{}; if(v.start_ts && !v.end_ts){ updates[`${s.key}/end_ts`]=fmtDDMMYYYY_HHMM(Date.now()); } });
        if(Object.keys(updates).length) await update(ref(dbServicios, `${R_OS}/${currentSolId}/servicios`), updates);
      }
      if(!confirm('¬øCerrar la OS?')) return;
      const now=Date.now();
      if(workInt){ clearInterval(workInt); workInt=null; }
      for(const k in timersByKey){ if(timersByKey[k].h){ clearInterval(timersByKey[k].h); timersByKey[k].h=null; } }
      await update(ref(dbSolicitudes, `/${currentSolId}`), { OS_CERRADA:true, OS_END_TS: fmtDDMMYYYY_HHMM(now), STATUS_DE_SOLICITUD: 'OS CERRADA' });
      overlay.classList.remove('show');
      alert('OS cerrada correctamente.');
    });

    /* ===== Transferir ===== */
    const transferOverlay=$id('transferOverlay');
    const openTransfer=()=> transferOverlay.classList.add('show');
    const closeTransfer=()=> transferOverlay.classList.remove('show');
    document.getElementById('btnTransferirOs').addEventListener('click', ()=>{
      if(!currentSolId){ alert('Abr√≠ una OS primero.'); return;}
      openTransfer();
    });
    const cancelBtn=$id('transferCancel'); if(cancelBtn) cancelBtn.addEventListener('click', closeTransfer);
    async function confirmTransfer(){
      if(!currentSolId) return;
      const sel = document.querySelector('input[name="destTransfer"]:checked')?.value || 'PROVEEDOR';
      const updates={}; if(sel==='PROVEEDOR') updates.STATUS_DE_SOLICITUD='TERCEROS'; if(sel==='COMPRAS') updates.STATUS_DE_SOLICITUD='COMPRAS';
      try{ await update(ref(dbSolicitudes, `/${currentSolId}`), updates); closeTransfer(); overlay.classList.remove('show'); alert('Solicitud transferida.'); }
      catch(e){ console.error(e); alert('No se pudo transferir.'); }
    }
    const confirmBtn=$id('transferConfirm'); if(confirmBtn) confirmBtn.addEventListener('click', confirmTransfer);
  </script>
</body>
</html>



