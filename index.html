<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>M√≥dulo Chofer ¬∑ Solicitud Taller</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ["Inter","ui-sans-serif","system-ui"] },
          colors: {
            brand: { 50:"#f0f6ff",100:"#dcebff",200:"#bed9ff",300:"#8fc0ff",400:"#5aa0ff",500:"#2d82ff",600:"#1a66e1",700:"#164fb0",800:"#153f88",900:"#112f66" }
          },
          boxShadow: { soft:"0 10px 30px rgba(0,0,0,.08)" }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    html,body{font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    /* Campos t√°ctiles */
    .touch{min-height:52px;font-size:16px;}
    /* Floating label simple */
    .fg{position:relative}
    .fg>label{position:absolute;left:14px;top:6px;font-size:12px;color:#64748b}
    .fg>input,.fg>select,.fg>textarea{padding-top:1.35rem}
    /* Safe area bottom para iPhone */
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 12px)}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- Header compacto -->
  <header class="bg-brand-800 text-white">
    <div class="mx-auto max-w-md px-4 py-3 flex items-center gap-3">
      <div class="text-2xl">üõ†Ô∏è</div>
      <div class="flex-1">
        <h1 class="text-base font-semibold leading-tight">Solicitud al Taller</h1>
        <p class="text-white/80 text-xs">Fadel T1 Ypan√©</p>
      </div>
    </div>
  </header>

  <!-- Form -->
  <main class="mx-auto max-w-md px-4 pt-4 pb-28">
    <form id="f" class="space-y-3">
      <p id="msg" class="text-sm text-slate-500"></p>

      <div class="fg">
        <label for="fh">Fecha y hora</label>
        <input id="fh" class="w-full touch rounded-2xl border border-slate-300 bg-slate-100 px-3" type="text" readonly/>
      </div>

      <div class="fg">
        <label for="chofer">Chofer</label>
        <select id="chofer" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Cargando choferes‚Ä¶</option>
        </select>
      </div>

      <div class="fg">
        <label for="movil">M√≥vil (730‚Äì759)</label>
        <select id="movil" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Seleccione</option>
        </select>
      </div>

      <div class="fg">
        <label for="tipo">Tipo</label>
        <select id="tipo" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Seleccione</option>
          <option value="CAVALO">CAVALO</option>
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div class="fg">
        <label for="destino">Destino</label>
        <select id="destino" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Seleccione</option>
          <option>TALLER</option>
          <option>GOMERIA</option>
          <option>LONERIA</option>
          <option>OTROS PROVEEDORES EXTERNOS</option>
        </select>
      </div>

      <div class="fg">
        <label for="motivo">Motivo</label>
        <select id="motivo" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Seleccione</option>
          <option>MECANICA</option>
          <option>ACCESORIOS</option>
          <option>CHAPERIA</option>
          <option>ELECTRICA</option>
          <option>FRENO</option>
          <option>NEUMATICOS</option>
          <option>SERVICIOS EXTERNOS</option>
          <option>SUMINISTRO</option>
        </select>
      </div>

      <div class="fg">
        <label for="ubic">Ubicaci√≥n</label>
        <input id="ubic" required placeholder="Ej: CDA, RIPIO, EN RUTA, CDE" class="w-full touch rounded-2xl border border-slate-300 bg-white px-3"/>
      </div>

      <div class="fg">
        <label for="status">Status del m√≥vil</label>
        <select id="status" required class="w-full touch rounded-2xl border border-slate-300 bg-white px-3">
          <option value="">Seleccione</option>
          <option>CON PRODUCTO</option>
          <option>CON ENVASES</option>
          <option>BOX VACIO</option>
        </select>
      </div>

      <div class="fg">
        <label for="coment">Comentario</label>
        <textarea id="coment" rows="3" placeholder="Detalle breve‚Ä¶" class="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2"></textarea>
      </div>
    </form>
  </main>

  <!-- Footer fijo -->
  <footer class="fixed inset-x-0 bottom-0 z-40 bg-white/95 backdrop-blur border-t border-slate-200 shadow-soft">
    <div class="mx-auto max-w-md px-4 py-3 safe-bottom">
      <button id="enviar" class="w-full h-12 rounded-2xl bg-brand-600 text-white font-semibold active:scale-[.99]">üì§ Enviar solicitud</button>
    </div>
  </footer>

  <!-- Bottom sheet de √©xito -->
  <div id="sheet" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close></div>
    <div class="absolute inset-x-0 bottom-0 max-w-md mx-auto rounded-t-3xl bg-white shadow-soft p-4 pb-6">
      <div class="flex items-center gap-3">
        <div class="text-3xl">‚úÖ</div>
        <div>
          <h3 class="font-bold">Solicitud enviada</h3>
          <p class="text-slate-600 text-sm">Ya est√° todo listo.</p>
        </div>
      </div>
      <a id="wa" target="_blank" rel="noopener" class="mt-3 inline-flex items-center justify-center gap-2 w-full h-12 rounded-2xl bg-[#25D366] text-white font-semibold">üì≤ Compartir por WhatsApp</a>
      <button data-close class="mt-2 w-full h-12 rounded-2xl border border-slate-300 text-slate-700">Cerrar</button>
    </div>
  </div>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, get, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    /* Firebase */
    const app = initializeApp({
      apiKey: "AIzaSyCHPVzlKuwPsM9JDrEQYwX2GumvunM7bso",
      authDomain: "solicitudes-b1d93.firebaseapp.com",
      databaseURL: "https://solicitudes-b1d93-default-rtdb.firebaseio.com",
      projectId: "solicitudes-b1d93",
      storageBucket: "solicitudes-b1d93.firebasestorage.app",
      messagingSenderId: "588418332403",
      appId: "1:588418332403:web:1523983421aa238562a986",
      measurementId: "G-819DG1W1MQ"
    });
    const db = getDatabase(app);
    const dbChoferes = getDatabase(app, "https://qlpchoferes-default-rtdb.firebaseio.com");

    /* Helpers */
    const $ = (id)=>document.getElementById(id);
    const nowText = ()=>{
      const d=new Date(), p=n=>String(n).padStart(2,'0');
      return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };
    const setFH = ()=> $('fh').value = nowText();

    // Inicializar
    setFH();
    // M√≥viles 730‚Äì759
    for(let i=730;i<=759;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; $('movil').appendChild(o); }
    // Choferes
    (async ()=>{
      try{
        const s=await get(ref(dbChoferes,'/'));
        const sel=$('chofer');
        if(!s.exists()){ sel.innerHTML='<option value="">Sin choferes</option>'; return; }
        const arr=[];
        s.forEach(n=>{ const v=n.val()||{}; const name=(v.CHOFER||'').toString().trim(); if(name) arr.push(name); });
        arr.sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
        sel.innerHTML='<option value="">Seleccione</option>';
        arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
      }catch{ $('chofer').innerHTML='<option value="">Error</option>'; }
    })();

    // Sheet helpers
    const sheet=$('sheet');
    sheet.addEventListener('click',e=>{ if(e.target.hasAttribute('data-close')) sheet.classList.add('hidden'); });

    // Enviar
    $('enviar').addEventListener('click', async ()=>{
      const f = document.getElementById('f');
      if(!f.checkValidity()){ f.reportValidity(); return; }

      const btn=$('enviar');
      btn.disabled=true; btn.classList.add('opacity-60','cursor-wait');

      const data = {
        "DESTINO": $('destino').value,
        "FECHA Y HORA": $('fh').value,
        "MOTIVO": $('motivo').value,
        "MOVIL": $('movil').value,
        "NRO_SOLICITUD": Math.floor(100000 + Math.random()*900000),
        "STATUS_DEL_MOVIL": $('status').value,
        "STATUS_DE_SOLICITUD": "PENDIENTE",
        "TIPO": $('tipo').value,
        "UBICACI√ìN": $('ubic').value.trim(),
        "CHOFER": $('chofer').value.trim(),
        "COMENTARIO": ($('coment').value||"").trim(),
        "_ts": serverTimestamp()
      };

      try{
        const nuevo = push(ref(db,'/'));
        await set(nuevo, data);

        // WhatsApp
        const texto = [
          "üõ†Ô∏è *Solicitud de Avance al Taller*",
          `üïí ${data["FECHA Y HORA"]}`,
          `üë§ ${data["CHOFER"]}`,
          `üöö M√≥vil: ${data["MOVIL"]} ¬∑ ${data["TIPO"]}`,
          `üìç ${data["DESTINO"]}`,
          `üõ†Ô∏è ${data["MOTIVO"]}`,
          `üìå ${data["UBICACI√ìN"]}`,
          `üö¶ ${data["STATUS_DEL_MOVIL"]}`,
          `üßæ ${data["NRO_SOLICITUD"]}`,
          data["COMENTARIO"]?`üìù ${data["COMENTARIO"]}`:""
        ].filter(Boolean).join('\n');
        $('wa').href = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;

        /* >>> LIMPIEZA AUTOM√ÅTICA (inmediata) <<< */
        f.reset();
        setFH();               // repone la hora actual
        window.scrollTo({top:0,behavior:'smooth'});

        // Mensaje de √©xito y sheet
        const msg=$('msg');
        msg.textContent='Solicitud creada correctamente.';
        msg.className='text-sm text-emerald-600';
        sheet.classList.remove('hidden');
      }catch(e){
        const msg=$('msg');
        msg.textContent='Ocurri√≥ un error al guardar.';
        msg.className='text-sm text-rose-600';
      }finally{
        btn.disabled=false; btn.classList.remove('opacity-60','cursor-wait');
      }
    });
  </script>
</body>
</html>
